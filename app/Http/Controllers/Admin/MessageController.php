<?php namespace App\Http\Controllers\Admin;use App\Http\Requests;use App\Http\Controllers\Controller;use Validator;use Illuminate\Http\Request;class MessageController extends Controller {    /**     * Display a listing of the resource.     *     * @return Response     */    public function index()    {        $results = \DB::table('messages')->where('send_user_id',\Auth::user()->id)->get();        foreach($results as $result){            $result->receive_user_id = \DB::table('users')->where('id',$result->receive_user_id)->first()->name;            $result->time = date('Y-m-d', $result->time);        }        return view('admin.sedlistmessage',['messages'=>$results]);    }    /**     * Show the form for creating a new resource.     *     * @return Response     */    public function create()    {        return view('admin.sendmsg');    }    /**     * Store a newly created resource in storage.     *     * @return Response     */    public function store(Request $request)    {        $username = $request->input('name');        $message = $request->input('message');        $v = Validator::make([            'username' => $username,            'message' => $message,        ], [            'username' => 'required',            'message' => 'required',        ],[            'username.required' => '用户名不能为空',            'message.required' => '信件内容不能为空',        ]);        if ($username == $request->user()->name) {            return redirect()->back()->withErrors("不能给自己发送信件.")->withInput();        }        if ($v->fails()) {            return redirect()->back()->withErrors($v->errors())->withInput();        }        $send = \DB::table('users')->where('name', $username)->first();        if($send){            \DB::table('messages')->insertGetId(                ['send_user_id' => \Auth::user()->id,'message'=>$message, 'receive_user_id' => $send->id,'status'=>1,'time'=>time()]            );        }else{            return redirect()->back()->withErrors("没有找到该用户.")->withInput();        }        return redirect('/hub/msg');    }    /**     * Display the specified resource.     *     * @param  int  $id     * @return Response     */    public function show($id)    {        $msg = \DB::table('messages')->find($id);        $msg->send_user_id  = \DB::table('users')->where('id',$msg->send_user_id)->first()->name;        $msg->receive_user_id  = \DB::table('users')->where('id',$msg->receive_user_id)->first()->name;        $msg->time = date('Y-m-d', $msg->time);        if ($msg->status==1) {            \DB::table('messages')->where('id', $id)->update(['status' => 2]);        }        return view('admin.mescate', ['msg' => $msg]);    }    /**     * Show the form for editing the specified resource.     *     * @param  int  $id     * @return Response     */    public function edit($id)    {        //    }    /**     * Update the specified resource in storage.     *     * @param  int  $id     * @return Response     */    public function update($id)    {        //    }    /**     * Remove the specified resource from storage.     *     * @param  int  $id     * @return Response     */    public function destroy($id)    {        \DB::table('messages')->where('id', $id)->delete();        return \Redirect::back();    }}